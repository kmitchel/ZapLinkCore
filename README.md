# ZapLinkCore

**ZapLinkCore** is a high-performance C-based backend engine for the **ZapLink** ecosystem. 
It serves a digital TV tuner (DVB/ATSC) over HTTP, providing rock-solid streaming, a standards-compliant XMLTV guide, and seamless network discovery.

## üåü The ZapLink Ecosystem
ZapLinkCore is the backbone of a multi-platform TV experience:
- **ZapLinkCore**: The high-performance C backend (This project).
- **ZapLinkWeb**: A modern web-based client for browser viewing.
- **ZapLinkTV**: A native AndroidTV client for the big screen.

## üöÄ Key Features

### **Streaming & Playback**
- **Direct MPEG-TS Streaming**: `/stream/{channel_number}` provides a low-latency stream directly from `dvbv5-zap`.
- **Intelligent Preemption**: Active stream requests automatically pause background EPG scans to ensure zero-wait, glitch-free viewing.
- **Dynamic M3U**: `/playlist.m3u` is auto-generated with correct IP addresses for instant player compatibility.

### **Advanced EPG Engine**
- **Robust MSS Parsing**: Correctly handles ATSC **Multiple String Structures**, supporting multi-language and multi-segment titles without corruption.
- **Huffman Decompression**: Native support for **ATSC A/65 Huffman coding** (table sets 1 & 2) via an external binary module (`huffman.bin`), enabling deep metadata extraction for compressed descriptions.
- **Concurrent Scanning**: Utilizes all available tuners to scan multiple frequencies in parallel, drastically reducing guide update times.

### **Zero-Conf Networking**
- **mDNS Discovery**: Advertises as **"ZapLinkCore"** (`_http._tcp`) on the local network. Clients can find it instantly without manual IP entry.

---

## üì¶ Build Instructions

ZapLinkCore offers a flexible build system for both system-integrated and self-contained deployments.

### Option A: Self-Contained Build (Recommended)
Downloads and compiles dependencies (SQLite) locally, isolating the build from system libraries.

```bash
# 1. Download and compile dependencies to ./deps
make setup

# 2. Build ZapLinkCore linked against local deps
make local
```

### Option B: System Build
Uses system-installed libraries (`pkg-config`). Ideal for package maintainers.

```bash
# Requirements: libsqlite3-dev, libavahi-client-dev, libavahi-common-dev
make
```

---

## üõ†Ô∏è Usage

1. **Configuration**:
   Ensure `channels.conf` is present in the working directory (generated by `scan` or `w_scan`).

2. **Run**:
   ```bash
   ./build/zaplinkcore [options]
   ```
   
   **Options:**
   - `-p <port>`: Port to listen on (Default: **18392**)
   - `-h`: Show usage information

3. **Example**:
   ```bash
   ./build/zaplinkcore -p 3000
   ```

---

## üìÇ Project Structure
- `src/`: Source code
  - **`main.c`**: Entry point & lifecycle management.
  - **`epg.c`**: ATSC/DVB parser, MSS decoder, and scanning logic.
  - **`huffman.c`**: Binary tree decoder for compressed strings.
  - **`tuner.c`**: Hardware resource management (locking/preemption).
  - **`http_server.c`**: Multi-threaded HTTP engine.
  - **`mdns.c`**: Avahi integration.
- `include/`: Header files.
- `support/`: Helper scripts (`setup_env.sh`, `gen_huffman.py`).
- `build/`: Output artifacts (`zaplinkcore`).
